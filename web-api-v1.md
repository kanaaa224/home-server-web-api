### WebAPI v1 リファレンス

## 概要
ユーザーAPI、ストレージAPIなどを使用してアプリやゲーム開発で使用・組み込むことができます。

※PHPの理解を深めたいため、フレームワーク禁止縛りの素のPHPで実装しています。  
そのため、バグがあったり予期しないエラー、データの消失があったりするかもしれません。  
あらかじめご了承ください...

## リクエスト
APIとの全ての通信においてHTTPSプロトコルでの接続が必要です。

リクエストには、```GET```、```POST```の2種類のHTTPメソッドを使用します。

## パラメーター
多くのメソッドでリクエストにパラメーターを含めることができますが、  
GETリクエストにパラメーターを含める場合にはURIクエリを使用し、それ以外の場合はリクエストボディを使用します。

## 呼び出し制限
使用するAPIによっては、一定時間に要求可能な回数に制限があります。  
このしきい値に達した場合、```429 (Too Many Requests)```のステータスコードを応答として返します。

## エラー
APIがエラーを返す場合があります。  
エラー時の応答はエラーコード、エラーの理由、エラーメッセージなどを含みます。

## ステータスコード
```200```、```201```、```204```、```400```、```401```、```403```、```404```、```429```、```500```などのステータスコードを使用します。  
エラーが起きた場合は、その他のステータスコードの中から適切なものを返します。

## レスポンス
ステータスコードが```200 (Success)```などなとき、データも返します。

## データ形式
JSON形式を使用します。  
JSONデータをリクエストボディに含める場合、リクエストのContent-Typeヘッダーに```application/json```を指定してください。  
ただし、GETリクエストにバラメーターを含める場合にはURIクエリを利用します。

## 認証
このシステムでは、PHPセッションを使用した認証システムを採用しています。  
ログイン時にセッションが開始され、その後のリクエストにセッションIDを含めることで認証を行います。  
セッションIDは通常Cookieで自動的に管理されますが、クライアントがCookieをサポートしていない場合は、
カスタムHTTPヘッダーやURIクエリを使用してセッションIDを送信します。

IDは```session-id```という名前のキーで管理されています。  
※セッションハイジャックの危険があるので、取り扱いに注意

## クラス
システムで使用可能な機能は、内部でクラス分けされ、メソッドとして構築されています。

使うときはまず、使いたいメソッドが属するクラスを```class```プロパティにプロパティ名で指定します。

例1: ```・・・/api/v1/?class=general&method=version```（GeneralAPIクラスの```version```メソッドを呼び出し）

クラスの指定を省略すると、自動でGeneralAPIが設定されます。

例2: ```・・・/api/v1/?method=version```（例1と同じ）

| クラス名 | 説明 | プロパティ名 |
| - | - | - |
| GeneralAPI | ログイン機能などの一般的な機能 | ```general```（省略可能） |
| SystemAPI | システムの情報を取得 | ```system``` |
| StorageAPI | ファイルストレージの利用 | ```storage``` |
| MusicAPI | 音楽アプリ開発時に必要になったため実装（著作権フリー&再配布可能音源を使用） | ```music``` |
| ServerAPI | サーバーの操作など | ```server``` |
| DebugAPI | 機能のデバッグ用 | ```debug``` |

## メソッド
使いたいメソッドを```method```プロパティで指定します。

例: ```・・・/api/v1/?method=version```（```version```メソッドを呼び出し）

※指定しないと```invalid-method```の失敗コードが返ります。

また、メソッドによって引数を渡す必要があります。  
引数は```params```プロパティで指定します。

例: ```・・・/api/v1/?method=account-create&params[id]=XXX&params[password]=XXX```（```account-create```メソッドを呼び出し、IDとPasswordを渡す）

※引数は通常POSTリクエストにリクエストボディで含めます。URIクエリで含めることも可能ですが、推奨されません。

### 全てのクラスで使えるメソッド
| メソッド名 | 説明 | 引数 | 呼び出し成功時の戻り値 |
| - | - | - | - |
| ```version``` | APIのバージョンを返します | 無し | ```string```（例: ```v1.0```） |
| ```methods``` | 使用可能なメソッドの名前一覧を返します | 無し | ```string array``` |

### GeneralAPI クラス
| メソッド名 | 説明 | 引数 | 呼び出し成功時の戻り値 |
| - | - | - | - |
| ```auth-challenge-start``` | チャレンジ認証を開始します | 無し | ```{ id: チャレンジ認証のID, challenge: 生成されたハッシュ, hash_algo: ハッシュ化アルゴリズム（デフォルトはsha256） }``` |
| ```auth-challenge``` | チャレンジ認証を行ないます。通常、内部で呼び出されるのでユーザーが使うことはありません | ```{ id: チャレンジ認証のID, hash: ハッシュ文字列, target: 認証の対象となる文字列 }``` | ```null``` |
| ```account-create``` | アカウントの作成をリクエストします。承認された場合自動で作成されます | ```{ id: ユーザーID（小文字の英数字で4文字以上）、16文字以内, password: ログインに使用するパスワード（大文字と小文字の英字、数字が各一文字以上含まれ、8文字以上、32文字以内） }``` | ```null``` |
| ```account-login``` | アカウントでシステムへチャレンジ認証を行ってログインします | ```{ id: ユーザーID, password: ログインパスワードのハッシュ, challenge: チャレンジ認証のID }``` | ```null``` |
| ```account-logout``` | ログイン済みの場合、ログアウトします | 無し | ```null``` |
| ```account-state``` | ログイン状態を返します | 無し | ```true``` or ```false``` |
| ```account-id``` | ログイン中のアカウントのIDを返します | 無し | ```string``` / ```null``` |
| ```account-data-set``` | アカウントのデータを設定します | ```{ key: token、password、name、emailのいずれか, value: keyで指定した種類に対応した文字列, password: ログインパスワードのハッシュ, challenge: チャレンジ認証のID }``` | ```null``` |
| ```account-data-get``` | アカウントに設定されたデータを取得します | ```{ key: token、name、emailのいずれか, password: ログインパスワードのハッシュ, challenge: チャレンジ認証のID }``` | ```null``` |
| ```login``` | ```account-login```メソッドのエイリアス |  |  |
| ```logout``` | ```account-logout```メソッドのエイリアス |  |  |

### SystemAPI クラス
| メソッド名 | 説明 | 引数 | 呼び出し成功時の戻り値 |
| - | - | - | - |
| ```database-engine``` | システムが使うDBエンジンの名前を返します | 無し | ```string```（例: ```MySQL```） |

### StorageAPI クラス
準備中...

### MusicAPI クラス
準備中...

### ServerAPI クラス
| メソッド名 | 説明 | 引数 | 呼び出し成功時の戻り値 |
| - | - | - | - |
| ```auth``` | 資格情報（パスワード）の実行権限を認証します。内部で使用されるためユーザーが使うことはありません | ```{ password: パスワード, command: app-launch、app-stop、app-configs-get、app-configs-set、app-update、details、add、delete、grant、revoke のいずれか }``` | ```null``` |
| ```credential-add``` | 資格情報を新たに追加します | ```{ password: 実行するための既存のパスワード（grant権限が必要）, new_credential: { password: 新しい資格情報のパスワード（英数字の8文字以上、32文字以内）, role: user、member、administrator のいずれか } }``` | ```null``` |
| ```credential-delete``` | 既存の資格情報を削除します | ```{ password: 実行するための既存のパスワード（revoke権限が必要）, target_credential: { password: 削除対象の資格情報（パスワード） } }``` | ```null``` |
| ```monitoring-app-add``` | 監視対象のアプリを新たに追加します | 準備中... | 追加されたアプリのID（```string```） |
| ```monitored-app-delete``` | 監視対象のアプリを除外します | ```{ password: 実行するためのパスワード（delete権限が必要）, app_id: アプリのID }``` | ```null``` |
| ```monitored-apps-get``` | 監視対象のアプリのID一覧を返します | 無し | ```string array``` |
| ```app-details-get``` | アプリの詳細情報を返します | ```{ password: 実行するためのパスワード（省略が可能で、した場合アプリの名前とタイプ、追加日時を、そうじゃない場合details権限が必要で全てのデータを返します）, app_id: アプリのID }``` | 準備中... |
| ```app-details-set``` | 準備中... |  |  |
| ```app-configs-get``` | アプリの設定ファイルの中身データを取得します | ```{ password: 実行するためのパスワード（app-configs-get権限が必要）, app_id: アプリのID }``` | ```string``` |
| ```app-configs-set``` | アプリの設定ファイルの中身を上書きします | ```{ password: 実行するためのパスワード（app-configs-set権限が必要）, app_id: アプリのID, data: 上書きするデータ }``` | ```null``` |
| ```app-logs-get``` | アプリのログファイルの中身データを取得します | ```{ password: 実行するためのパスワード（app-configs-get権限が必要）, app_id: アプリのID }``` | ```string``` |
| ```app-status-get``` | アプリの状態を返します | ```{ app_id: アプリのID }``` | ```stopped``` / ```running``` / ```updating``` |
| ```app-operate``` | アプリの起動・停止・アップデートのいずれかを行ないます | ```{ password: 実行するためのパスワード（操作に対応する権限が必要）, app_id: アプリのID, command: launch、stop、update のいずれか }``` | ```null``` |

## 戻り値
全てのメソッドにおいて、以下のような形式で呼び出し結果や値がレスポンスとして返ります。

```
# 戻り値が無いメソッドで呼び出しに成功

{
  "status": true,        // APIのコールが正常に完了
  "data": {
    "result": "success", // メソッドの呼び出しに成功
    "value": null        // 戻り値無し
  }
}
```

```
# バージョンを返すメソッドで呼び出しに成功

{
  "status": true,        // APIのコールが正常に完了
  "data": {
    "result": "success", // メソッドの呼び出しに成功
    "value": "v1.0"      // 戻り値
  }
}
```

```
# 呼び出しに失敗

{
  "status": true,        // APIのコールが正常に完了
  "data": {
    "result": "failed",  // メソッドの呼び出しに失敗
    "value": "fail-code" // 失敗時は文字列型の失敗コードを返します
  }
}
```

※```status```は基本的に常に```true```となりますが、内部エラーや例外スローが発生した場合に```false```となります。

### 失敗コードの対応一覧
| コード | 説明 |
| - | - |
| ```access-failed``` | アクセスに失敗 |
| ```auth-failed``` | 認証に失敗 |
| ```already-done``` | 既に完了済み |
| ```already-exist``` | 既に存在済み |
| ```invalid-class``` | クラスの指定が不正 |
| ```invalid-method``` | メソッドの指定が不正 |
| ```invalid-params``` | 引数（ペイロード）が不正 |
| ```incorrect``` | 不一致 |
| ```not-executable``` | 実行できる状態でない |
| ```not-exist``` | 存在しない |
| ```not-set``` | 設定されていない |
| ```uncertified``` | 認証されていない |
| ```unauthorized``` | ログインされていない |
| ```suspicious-activity-detected``` | 不審なアクティビティを検知 |
| ```permission-denied``` | 権限不足のため拒否 |
| ```error``` | 内部処理エラー |
| ```null``` | 失敗 |

## コンテンツ フェッチ
秘匿性の高いデータやファイルにアクセスする際、コンテンツ フェッチ機能を使います。

事前にフェッチが必要なメソッドでフェッチのリクエストを行っておき、

```・・・/api/v1/fetch/?token=XXX```

のように、```fetch```URIへ```token```プロパティでデータへのアクセスを指定します。

なおこのとき、レスポンスデータはJSON形式ではなくデータそのものの形式となります。

※データへのアクセス及びトークンには有効期限があります。  
※登録されたときのIPアドレスとユーザーエージェントがアクセス時と同一でないとアクセスできません。  
※元々画像取得や音源ファイルのストリーミング機能実装のため開発したため、```206（範囲リクエスト）```に対応しています。